<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>reactor io的一种实现</title>
  <link rel="stylesheet" href="https://stackedit.io/style.css" />
</head>

<body class="stackedit">
  <div class="stackedit__html"><p>下面是一个reactor模式下的io简单类图：<br>
<img src="data:image/png;base64,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"><br>
reactor::run是一个死循环，单独占用一个线程，循环体内容是：<br>
调用load_event()，加载自上次以来变化的事件，函数会调用_dispatch的add_event()和del_event()，将要监听的fd和该fd上关心的事件告知demultiplexer；<br>
调用<code>_dispatch-&gt;dispatch()</code>进入wait状态，等待事件发生或超时。</p>
<p>passiveio_event和activeio_event的作用是建立tcp连接，即创建streamio_event对象，然后将其加入reactor。<br>
在已建立的连接上有事件发生时，找到其对应的streamio_event对象，根据是读还是写调用handle_read()或handle_write()。<br>
在handle_read()或handle_write()内部，则委托给session *_ses负责具体的逻辑。</p>
<p>一个session对应一个连接，它的内部可能会有接收和发送缓冲，加解密等一些组件；session_manager组织了多个session，调用session_manager的send时，需要指定一个sid，send会找到对应session，session在做了一些工作后，向reactor添加可以发送的事件，这会唤醒demultiplexer::dispatch()，然后去发送数据。</p>
<p>reactor包含demuliplexer和多个event，但调用demuliplexer::dispatch()时又会把reactor传过去，event内部也有指向reactor的指针，这三个类耦合比较紧密，但好在它们整体对外解耦了。<br>
session内部有指向session_manager的指针，session_manager管理着session，在我看来这样实在不好。在看wdb代码时，page类内部有指向pagecache类的指针，我通过把b树的merge、split等操作从page移到pagecache，使得page类不再需要使用pagecache的方法了，但这里却是不好将session和session_manager解耦。</p>
</div>
</body>

</html>
