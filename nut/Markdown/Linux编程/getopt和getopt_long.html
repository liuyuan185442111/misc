<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>getopt和getopt_long</title>
  <link rel="stylesheet" href="https://stackedit.io/style.css" />
</head>

<body class="stackedit">
  <div class="stackedit__html"><h1><a id="getopt_0"></a>getopt</h1>
<pre class=" language-c"><code class="prism  language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;getopt.h&gt;</span> </span><span class="token comment">// man里说是#include &lt;unistd.h&gt;</span>
<span class="token keyword">int</span> <span class="token function">getopt</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span> <span class="token keyword">const</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>optstring<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">extern</span> <span class="token keyword">char</span> <span class="token operator">*</span>optarg<span class="token punctuation">;</span>
<span class="token keyword">extern</span> <span class="token keyword">int</span> optind<span class="token punctuation">,</span> opterr<span class="token punctuation">,</span> optopt<span class="token punctuation">;</span>
</code></pre>
<p>如果选项成功找到，返回选项字符；如果所有命令行选项都解析完毕，返回 -1；如果遇到选项字符不在 optstring 中，返回字符 ‘?’，并将 optopt 置为该选项字符；如果遇到丢失参数，返回 ‘?’ 或 ‘:’，当返回返回 ‘?’ 时且 opterr 非 0 会提示错误信息。</p>
<p>optarg —— 指向当前选项参数（如果有）的指针或NULL（无参数）。<br>
optind —— 再次调用 getopt() 时下一个 argv-element 的索引。<br>
optopt —— 最后一个未知选项。<br>
opterr ­—— 是否希望 getopt() 向 stderr 打印出错信息，0 为不打印，opterr 默认非0。</p>
<p>optstring：由三部分组成，第一部分是可选的字符’+‘或’-’，第二部分是一个可选的字符’;’，第三部分是具体的选项字符串。<br>
举例说明第三部分 “ab:c::d:e”，abcde 分别是选项字符，选项字符其后跟 “:” 表示该选项有参数，选项跟参数之间可有空格，也可没有空格，选项字符后跟 “::” 表示参数可有可无，但如果有参数选项和参数之间不能有空格，选项字符后不跟 “:” 或 “::” 表示该选项没参数。"-ae -b100 -c -d 200"就是一个对应于上述 optstring 的命令选项，没参数的选项可以写在一起，比如 -ae。<br>
getopt() 默认情况下会改变参数的顺序，从而使 nonoption argv-element 移至所有选项之后，但如果 optstring 第一部分是字符 ‘+’，或者设置了环境变量POSIXLY_CORRECT，第一个 nonoption argv-element 出现时立即停止选项处理，例如 “+ab:c::d:e”，"-ae 100 -c -d 200" 中 100 及其以后的参数都不再作为选项处理。<br>
如果第一部分是 ‘-’，每个 nonoption argv-element 作为选项 1 的参数，这里的 1 是数字 1 不是字符 1。<br>
如果第二部分的 ‘:’ 存在，当丢失选项参数时 getopt() 不再返回 ‘?’ 而是返回 ‘:’，且不会打印出错信息。</p>
<p>The special argument “–” forces an end of option-scanning regardless of the scanning mode.</p>
<pre class=" language-c"><code class="prism  language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;getopt.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">int</span> opt<span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>optstring <span class="token operator">=</span> <span class="token string">"ab:c::d:e"</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>opt <span class="token operator">=</span> <span class="token function">getopt</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> optstring<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"opt = %c(%d)\t"</span><span class="token punctuation">,</span> opt<span class="token punctuation">,</span> opt<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"optarg = %s\t"</span><span class="token punctuation">,</span> optarg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"optind = %d\t"</span><span class="token punctuation">,</span> optind<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"argv[optind] = %s\t"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span>optind<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"optopt = %c\(%d)n"</span><span class="token punctuation">,</span> optopt<span class="token punctuation">,</span> optopt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"after processing optind = %d, argv[optind] = %s\n"</span><span class="token punctuation">,</span> optind<span class="token punctuation">,</span> argv<span class="token punctuation">[</span>optind<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token operator">/</span>a<span class="token punctuation">.</span>out file <span class="token operator">-</span>ae <span class="token operator">-</span>b100 <span class="token operator">-</span>c <span class="token operator">-</span>z <span class="token operator">-</span>d <span class="token number">200</span>
opt <span class="token operator">=</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token number">97</span><span class="token punctuation">)</span>     optarg <span class="token operator">=</span> <span class="token punctuation">(</span>null<span class="token punctuation">)</span> optind <span class="token operator">=</span> <span class="token number">2</span>      argv<span class="token punctuation">[</span>optind<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span>ae      optopt <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
opt <span class="token operator">=</span> <span class="token function">e</span><span class="token punctuation">(</span><span class="token number">101</span><span class="token punctuation">)</span>    optarg <span class="token operator">=</span> <span class="token punctuation">(</span>null<span class="token punctuation">)</span> optind <span class="token operator">=</span> <span class="token number">3</span>      argv<span class="token punctuation">[</span>optind<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span>b100    optopt <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
opt <span class="token operator">=</span> <span class="token function">b</span><span class="token punctuation">(</span><span class="token number">98</span><span class="token punctuation">)</span>     optarg <span class="token operator">=</span> <span class="token number">100</span>    optind <span class="token operator">=</span> <span class="token number">4</span>      argv<span class="token punctuation">[</span>optind<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span>c       optopt <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
opt <span class="token operator">=</span> <span class="token function">c</span><span class="token punctuation">(</span><span class="token number">99</span><span class="token punctuation">)</span>     optarg <span class="token operator">=</span> <span class="token punctuation">(</span>null<span class="token punctuation">)</span> optind <span class="token operator">=</span> <span class="token number">5</span>      argv<span class="token punctuation">[</span>optind<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span>z       optopt <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token operator">/</span>a<span class="token punctuation">.</span>out<span class="token punctuation">:</span> invalid option <span class="token operator">--</span> <span class="token string">'z'</span>
opt <span class="token operator">=</span> <span class="token operator">?</span><span class="token punctuation">(</span><span class="token number">63</span><span class="token punctuation">)</span>     optarg <span class="token operator">=</span> <span class="token punctuation">(</span>null<span class="token punctuation">)</span> optind <span class="token operator">=</span> <span class="token number">6</span>      argv<span class="token punctuation">[</span>optind<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span>d       optopt <span class="token operator">=</span> <span class="token function">z</span><span class="token punctuation">(</span><span class="token number">122</span><span class="token punctuation">)</span>
opt <span class="token operator">=</span> <span class="token function">d</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>    optarg <span class="token operator">=</span> <span class="token number">200</span>    optind <span class="token operator">=</span> <span class="token number">8</span>      argv<span class="token punctuation">[</span>optind<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>null<span class="token punctuation">)</span>   optopt <span class="token operator">=</span> <span class="token function">z</span><span class="token punctuation">(</span><span class="token number">122</span><span class="token punctuation">)</span>
after processing optind <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span>optind<span class="token punctuation">]</span> <span class="token operator">=</span> file

<span class="token punctuation">.</span><span class="token operator">/</span>a<span class="token punctuation">.</span>out file  <span class="token operator">-</span>ae <span class="token operator">--</span> <span class="token operator">-</span>b100 <span class="token operator">-</span>c <span class="token operator">-</span>z <span class="token operator">-</span>d <span class="token number">200</span>
opt <span class="token operator">=</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token number">97</span><span class="token punctuation">)</span>     optarg <span class="token operator">=</span> <span class="token punctuation">(</span>null<span class="token punctuation">)</span> optind <span class="token operator">=</span> <span class="token number">2</span>      argv<span class="token punctuation">[</span>optind<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span>ae      optopt <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
opt <span class="token operator">=</span> <span class="token function">e</span><span class="token punctuation">(</span><span class="token number">101</span><span class="token punctuation">)</span>    optarg <span class="token operator">=</span> <span class="token punctuation">(</span>null<span class="token punctuation">)</span> optind <span class="token operator">=</span> <span class="token number">3</span>      argv<span class="token punctuation">[</span>optind<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">--</span>       optopt <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
after processing optind <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span>optind<span class="token punctuation">]</span> <span class="token operator">=</span> file
</code></pre>
<h1><a id="getopt_long_54"></a>getopt_long</h1>
<pre class=" language-c"><code class="prism  language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;getopt.h&gt;</span></span>
<span class="token keyword">struct</span> option <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span>
    <span class="token keyword">int</span>         has_arg<span class="token punctuation">;</span>
    <span class="token keyword">int</span>        <span class="token operator">*</span>flag<span class="token punctuation">;</span>
    <span class="token keyword">int</span>         val<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">getopt_long</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span> <span class="token keyword">const</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>optstring<span class="token punctuation">,</span>
           <span class="token keyword">const</span> <span class="token keyword">struct</span> option <span class="token operator">*</span>longopts<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>longindex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">getopt_long_only</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span> <span class="token keyword">const</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>optstring<span class="token punctuation">,</span>
           <span class="token keyword">const</span> <span class="token keyword">struct</span> option <span class="token operator">*</span>longopts<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>longindex<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>The getopt_long() function works like getopt() except that it also accepts long options, started with two dashes. A long option may take a parameter, of the form --arg=param or --arg param.</p>
<p>option 的成员意义如下：<br>
name<br>
长选项的名字。<br>
has_arg<br>
no_argument (or 0) 选项没有参数；required_argument (or 1) 选项有一个参数ment; optional_argument (or 2) 选项可有可无参数。<br>
flag<br>
标识结果如何返回。选项如果被找到，如果 flag 是 NULL，getopt_long() 将会返回 val，否则 getopt_long() 返回 0，而且 *flag 被设置为 val；选项如果未被找到，getopt_long() 返回 ‘?’，*flag（如果 flag 不为 NULL ） 保持不变。<br>
val<br>
标识返回值。</p>
<p>longopts 的最后一个元素必须 be filled with zeros。<br>
如果 longindex 不是 NULL，*longindex 将被设置为长选项在 longopts 中的索引。</p>
<p>getopt_long_only() is like getopt_long(), but ‘-’ as well as “–” can indicate a long option. If an option that starts with ‘-’ (not “–”) doesn’t match a long option, but does match a short option, it is parsed as a short option instead.</p>
<h1><a id="_84"></a>参考</h1>
<p><a href="https://linux.die.net/man/3/getopt">https://linux.die.net/man/3/getopt</a></p>
</div>
</body>

</html>
