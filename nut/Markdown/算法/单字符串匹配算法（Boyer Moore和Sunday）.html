<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>单字符串匹配算法（Boyer Moore和Sunday）</title>
  <link rel="stylesheet" href="https://stackedit.io/style.css" />
</head>

<body class="stackedit">
  <div class="stackedit__html"><p>字符串匹配（查找）算法是一类重要的字符串算法，给定一个长度为n的字符串text，要求找出text中是否存在另一个长度为m的字符串pattern（模式串）。<br>
主要方法有朴素算法，KMP算法，BM（Boyer Moore）算法，Sunday算法。<br>
朴素算法就是暴力匹配，KMP非常有名，但效率感人，不多说。<br>
关于<a href="http://www.ruanyifeng.com/blog/2013/05/boyer-moore_string_search_algorithm.html">Boyer-Moore算法</a>和<a href="https://www.jianshu.com/p/2e6eb7386cd3">Sunday算法</a>，<a href="http://www.ruanyifeng.com/blog/2013/05/boyer-moore_string_search_algorithm.html">《字符串匹配的Boyer-Moore算法》</a>和<a href="https://www.jianshu.com/p/2e6eb7386cd3">《字符串匹配算法之Sunday算法》</a>两篇文章讲得很清楚。<br>
<a href="https://www.jianshu.com/p/2e6eb7386cd3">《字符串匹配算法之Sunday算法》</a>对他们的效率进行了分析。</p>
<p>我实现了BM和Sunday算法，并同string::find做了对比，O3优化，测试发现pattern字符串比较小的时候，string::find优势巨大，比BM和Sunday高效数倍，pattern增大的过程中，BM渐渐和string::find相当了（但效率还是稍低），Sunday变得优秀了，花费的时间是string::find的37%左右。（注：1. Sunday始终比BM效率高 2.启不启用“好后缀”对BM影响不大）</p>
<p>为什么和理论分析不太一样呢？我猜测原因可能有：string::find可能并不是暴力匹配；标准库有优化；我的实现不够好；测试数据有问题；pattern字符串小的时候，BM和Sunday额外的操作带来的效率提升不如花费的成本。</p>
<p>结论：大部分时候string::find足够了，如有需要可以用Sunday算法。<br>
BM算法比Sunday算法复杂的多，实现BM用了半天，实现Sunday只用了不到一个小时。简单可能更好。</p>
<p>附上测试代码：</p>
<pre><code class="prism language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;vector&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"boyermoore.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"sunday.h"</span></span>

<span class="token keyword">using</span> std<span class="token operator">::</span>string<span class="token punctuation">;</span>
<span class="token keyword">using</span> std<span class="token operator">::</span>cout<span class="token punctuation">;</span>
<span class="token keyword">using</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> table<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span>
<span class="token punctuation">{</span>
	<span class="token string">'0'</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">,</span><span class="token string">'2'</span><span class="token punctuation">,</span><span class="token string">'3'</span><span class="token punctuation">,</span><span class="token string">'4'</span><span class="token punctuation">,</span><span class="token string">'5'</span><span class="token punctuation">,</span><span class="token string">'6'</span><span class="token punctuation">,</span><span class="token string">'7'</span><span class="token punctuation">,</span><span class="token string">'8'</span><span class="token punctuation">,</span><span class="token string">'9'</span><span class="token punctuation">,</span><span class="token string">'&lt;'</span><span class="token punctuation">,</span><span class="token string">'&gt;'</span><span class="token punctuation">,</span><span class="token string">' '</span><span class="token punctuation">,</span>
	<span class="token string">'A'</span><span class="token punctuation">,</span><span class="token string">'B'</span><span class="token punctuation">,</span><span class="token string">'C'</span><span class="token punctuation">,</span><span class="token string">'D'</span><span class="token punctuation">,</span><span class="token string">'E'</span><span class="token punctuation">,</span><span class="token string">'F'</span><span class="token punctuation">,</span><span class="token string">'G'</span><span class="token punctuation">,</span><span class="token string">'H'</span><span class="token punctuation">,</span><span class="token string">'I'</span><span class="token punctuation">,</span><span class="token string">'J'</span><span class="token punctuation">,</span><span class="token string">'K'</span><span class="token punctuation">,</span><span class="token string">'L'</span><span class="token punctuation">,</span><span class="token string">'M'</span><span class="token punctuation">,</span>
	<span class="token string">'N'</span><span class="token punctuation">,</span><span class="token string">'O'</span><span class="token punctuation">,</span><span class="token string">'P'</span><span class="token punctuation">,</span><span class="token string">'Q'</span><span class="token punctuation">,</span><span class="token string">'R'</span><span class="token punctuation">,</span><span class="token string">'S'</span><span class="token punctuation">,</span><span class="token string">'T'</span><span class="token punctuation">,</span><span class="token string">'U'</span><span class="token punctuation">,</span><span class="token string">'V'</span><span class="token punctuation">,</span><span class="token string">'W'</span><span class="token punctuation">,</span><span class="token string">'X'</span><span class="token punctuation">,</span><span class="token string">'Y'</span><span class="token punctuation">,</span><span class="token string">'Z'</span><span class="token punctuation">,</span>
	<span class="token string">'a'</span><span class="token punctuation">,</span><span class="token string">'b'</span><span class="token punctuation">,</span><span class="token string">'c'</span><span class="token punctuation">,</span><span class="token string">'d'</span><span class="token punctuation">,</span><span class="token string">'e'</span><span class="token punctuation">,</span><span class="token string">'f'</span><span class="token punctuation">,</span><span class="token string">'g'</span><span class="token punctuation">,</span><span class="token string">'h'</span><span class="token punctuation">,</span><span class="token string">'i'</span><span class="token punctuation">,</span><span class="token string">'j'</span><span class="token punctuation">,</span><span class="token string">'k'</span><span class="token punctuation">,</span><span class="token string">'l'</span><span class="token punctuation">,</span><span class="token string">'m'</span><span class="token punctuation">,</span>
	<span class="token string">'n'</span><span class="token punctuation">,</span><span class="token string">'o'</span><span class="token punctuation">,</span><span class="token string">'p'</span><span class="token punctuation">,</span><span class="token string">'q'</span><span class="token punctuation">,</span><span class="token string">'r'</span><span class="token punctuation">,</span><span class="token string">'s'</span><span class="token punctuation">,</span><span class="token string">'t'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">,</span><span class="token string">'v'</span><span class="token punctuation">,</span><span class="token string">'w'</span><span class="token punctuation">,</span><span class="token string">'x'</span><span class="token punctuation">,</span><span class="token string">'y'</span><span class="token punctuation">,</span><span class="token string">'z'</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">FindStr</span>
<span class="token punctuation">{</span>
	std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> strs<span class="token punctuation">;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
	<span class="token keyword">void</span> <span class="token function">make_strs</span><span class="token punctuation">(</span><span class="token keyword">int</span> min_len<span class="token punctuation">,</span> <span class="token keyword">int</span> max_len<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token function">srand</span><span class="token punctuation">(</span><span class="token number">99999</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>count<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			<span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token punctuation">(</span>max_len <span class="token operator">-</span> min_len<span class="token punctuation">)</span> <span class="token operator">+</span> min_len<span class="token punctuation">;</span>
			string <span class="token function">str</span><span class="token punctuation">(</span>len<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> j<span class="token operator">&lt;</span>len<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span>
				str<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> table<span class="token punctuation">[</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>table<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
			strs<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">int</span> <span class="token function">search1</span><span class="token punctuation">(</span><span class="token keyword">const</span> string <span class="token operator">&amp;</span>str<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token keyword">int</span> ret_c <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span> <span class="token operator">&amp;</span>i<span class="token operator">:</span>strs<span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token operator">!=</span> string<span class="token operator">::</span>npos<span class="token punctuation">)</span> <span class="token operator">++</span>ret_c<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> ret_c<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">int</span> <span class="token function">search2</span><span class="token punctuation">(</span><span class="token keyword">const</span> string <span class="token operator">&amp;</span>str<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		BoyerMoore <span class="token function">bm</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> ret_c <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span> <span class="token operator">&amp;</span>i<span class="token operator">:</span>strs<span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>bm<span class="token punctuation">.</span><span class="token function">findin</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">++</span>ret_c<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> ret_c<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">int</span> <span class="token function">search3</span><span class="token punctuation">(</span><span class="token keyword">const</span> string <span class="token operator">&amp;</span>str<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		Sunday <span class="token function">s</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> ret_c <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span> <span class="token operator">&amp;</span>i<span class="token operator">:</span>strs<span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">findin</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">++</span>ret_c<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> ret_c<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/time.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	FindStr s<span class="token punctuation">;</span>
	s<span class="token punctuation">.</span><span class="token function">make_strs</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">,</span> <span class="token number">9800</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	string <span class="token function">pattern</span><span class="token punctuation">(</span><span class="token string">"p4rDtntwBOohZzovBXPIvmQyAlW3BsV1aY3tUofJRt9T3es1aj4UKG0Da04m6F0Qkyem6KzoPucNMU7gyPoXDpbKCYyiqXZSIJkHhOi3719vNCsOyJdofOYinSJxhWNZjVvuBME92OfYCqxKPjtLiNd1U2Aeqfpuq2LWaaw9iIFUEnMVesydIX4Q1Lj5uJKq91JPHht4z5EZ4OidE3RhdcIoyVFsbhwXDSeCQVFilps5oaVY7SfHEwnQcWffR7eT4dqV1cvSJ6jqzaWA1jGlpirfIvSzyn9v6ZNP7nyagxzs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> timeval start<span class="token punctuation">,</span> stop<span class="token punctuation">;</span>
	<span class="token function">gettimeofday</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>start<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	cout <span class="token operator">&lt;&lt;</span> <span class="token string">"find "</span> <span class="token operator">&lt;&lt;</span> s<span class="token punctuation">.</span><span class="token function">search1</span><span class="token punctuation">(</span>pattern<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	<span class="token function">gettimeofday</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>stop<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	cout <span class="token operator">&lt;&lt;</span> <span class="token string">"search1 using "</span> <span class="token operator">&lt;&lt;</span> stop<span class="token punctuation">.</span>tv_sec<span class="token operator">*</span><span class="token number">1000</span> <span class="token operator">+</span> stop<span class="token punctuation">.</span>tv_usec<span class="token operator">/</span><span class="token number">1000</span> <span class="token operator">-</span> start<span class="token punctuation">.</span>tv_sec<span class="token operator">*</span><span class="token number">1000</span> <span class="token operator">-</span> start<span class="token punctuation">.</span>tv_usec<span class="token operator">/</span><span class="token number">1000</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"ms"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	<span class="token function">gettimeofday</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>start<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	cout <span class="token operator">&lt;&lt;</span> <span class="token string">"find "</span> <span class="token operator">&lt;&lt;</span> s<span class="token punctuation">.</span><span class="token function">search2</span><span class="token punctuation">(</span>pattern<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	<span class="token function">gettimeofday</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>stop<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	cout <span class="token operator">&lt;&lt;</span> <span class="token string">"search2 using "</span> <span class="token operator">&lt;&lt;</span> stop<span class="token punctuation">.</span>tv_sec<span class="token operator">*</span><span class="token number">1000</span> <span class="token operator">+</span> stop<span class="token punctuation">.</span>tv_usec<span class="token operator">/</span><span class="token number">1000</span> <span class="token operator">-</span> start<span class="token punctuation">.</span>tv_sec<span class="token operator">*</span><span class="token number">1000</span> <span class="token operator">-</span> start<span class="token punctuation">.</span>tv_usec<span class="token operator">/</span><span class="token number">1000</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"ms"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	<span class="token function">gettimeofday</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>start<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	cout <span class="token operator">&lt;&lt;</span> <span class="token string">"find "</span> <span class="token operator">&lt;&lt;</span> s<span class="token punctuation">.</span><span class="token function">search3</span><span class="token punctuation">(</span>pattern<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	<span class="token function">gettimeofday</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>stop<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	cout <span class="token operator">&lt;&lt;</span> <span class="token string">"search3 using "</span> <span class="token operator">&lt;&lt;</span> stop<span class="token punctuation">.</span>tv_sec<span class="token operator">*</span><span class="token number">1000</span> <span class="token operator">+</span> stop<span class="token punctuation">.</span>tv_usec<span class="token operator">/</span><span class="token number">1000</span> <span class="token operator">-</span> start<span class="token punctuation">.</span>tv_sec<span class="token operator">*</span><span class="token number">1000</span> <span class="token operator">-</span> start<span class="token punctuation">.</span>tv_usec<span class="token operator">/</span><span class="token number">1000</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"ms"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

find <span class="token number">0</span>
search1 <span class="token keyword">using</span> <span class="token number">76</span>ms
find <span class="token number">0</span>
search2 <span class="token keyword">using</span> <span class="token number">82</span>ms
find <span class="token number">0</span>
search3 <span class="token keyword">using</span> <span class="token number">29</span>ms
</code></pre>
</div>
</body>

</html>
