<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lua之实现一个bool数组</title>
<link rel="stylesheet" href="https://stackedit.io/res-min/themes/base.css" />
<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body><div class="container"><pre class="prettyprint"><code class=" hljs cs"><span class="hljs-preprocessor">#include &lt;stdlib.h&gt;</span>
<span class="hljs-preprocessor">#include &lt;limits.h&gt;</span>
<span class="hljs-preprocessor">#include "lua.h"</span>
<span class="hljs-preprocessor">#include "lauxlib.h"</span>

<span class="hljs-preprocessor">#<span class="hljs-keyword">define</span> BITS_PER_WORD (CHAR_BIT*sizeof(unsigned int))</span>
<span class="hljs-preprocessor">#<span class="hljs-keyword">define</span> I_WORD(n) ((n-1+BITS_PER_WORD)/BITS_PER_WORD)</span>
<span class="hljs-preprocessor">#<span class="hljs-keyword">define</span> I_MASK(n) (1&lt;&lt;((n-1)%BITS_PER_WORD))</span>

typedef <span class="hljs-keyword">struct</span> BoolArray {
    <span class="hljs-keyword">int</span> size;
    unsigned <span class="hljs-keyword">int</span> <span class="hljs-keyword">value</span>[<span class="hljs-number">0</span>];
} BoolArray;

<span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> newArray(lua_State *L)
{
    <span class="hljs-keyword">int</span> n = luaL_checkint(L, <span class="hljs-number">1</span>);
    luaL_argcheck(L, n&gt;<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-string">"invalid size"</span>);
    <span class="hljs-keyword">int</span> nbytes = <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>) + <span class="hljs-keyword">sizeof</span>(unsigned <span class="hljs-keyword">int</span>)*I_WORD(n);
    BoolArray *b = (BoolArray*)lua_newuserdata(L, nbytes);
    b-&gt;size = n;
    <span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;
    <span class="hljs-keyword">for</span>(; i&lt;I_WORD(n); ++i)
        b-&gt;<span class="hljs-keyword">value</span>[i] = <span class="hljs-number">0</span>;
    luaL_getmetatable(L, <span class="hljs-string">"ba.meta"</span>);
    lua_setmetatable(L, -<span class="hljs-number">2</span>);<span class="hljs-comment">//将创建的userdata的metatable设为栈顶的ba.meta</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
}

<span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> setArray(lua_State *L)
{
    BoolArray *b = (BoolArray*)luaL_checkudata(L, <span class="hljs-number">1</span>, <span class="hljs-string">"ba.meta"</span>);
    <span class="hljs-keyword">int</span> index = luaL_checkint(L, <span class="hljs-number">2</span>);
    luaL_argcheck(L, index&gt;<span class="hljs-number">0</span> &amp;&amp; index&lt;=b-&gt;size, <span class="hljs-number">1</span>, <span class="hljs-string">"index out of range"</span>);
    <span class="hljs-keyword">if</span>(lua_toboolean(L, <span class="hljs-number">3</span>))
        b-&gt;<span class="hljs-keyword">value</span>[I_WORD(index)] |= I_MASK(index);
    <span class="hljs-keyword">else</span>
        b-&gt;<span class="hljs-keyword">value</span>[I_WORD(index)] &amp;= ~I_MASK(index);
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}

<span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> getArray(lua_State *L)
{
    BoolArray *b = (BoolArray*)luaL_checkudata(L, <span class="hljs-number">1</span>, <span class="hljs-string">"ba.meta"</span>);
    <span class="hljs-keyword">int</span> index = luaL_checkint(L, <span class="hljs-number">2</span>);
    luaL_argcheck(L, index&gt;<span class="hljs-number">0</span> &amp;&amp; index&lt;=b-&gt;size, <span class="hljs-number">1</span>, <span class="hljs-string">"index out of range"</span>);
    lua_pushboolean(L, b-&gt;<span class="hljs-keyword">value</span>[I_WORD(index)] &amp; I_MASK(index));
    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
}

<span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> getSize(lua_State *L)
{
    BoolArray *b = (BoolArray*)luaL_checkudata(L, <span class="hljs-number">1</span>, <span class="hljs-string">"ba.meta"</span>);
    lua_pushinteger(L, b-&gt;size);
    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
}

<span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> luaL_Reg lib[] = {
    {<span class="hljs-string">"new"</span>, newArray},
    {NULL, NULL}
};
<span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> luaL_Reg lib_m[] = {
    {<span class="hljs-string">"size"</span>, getSize},
    {<span class="hljs-string">"set"</span>, setArray},
    {<span class="hljs-string">"get"</span>, getArray},
    {NULL, NULL}
};

LUA_API <span class="hljs-keyword">int</span> luaopen_boolarray (lua_State *L) {
    luaL_newmetatable(L, <span class="hljs-string">"ba.meta"</span>);<span class="hljs-comment">//创建一个metatable</span>
    lua_pushvalue(L, -<span class="hljs-number">1</span>);<span class="hljs-comment">//复制它</span>
    lua_setfield(L, -<span class="hljs-number">2</span>, <span class="hljs-string">"__index"</span>);<span class="hljs-comment">//将它的__index指向它自己</span>
    luaL_register(L, NULL, lib_m);<span class="hljs-comment">//为栈顶的table添加一些成员</span>
    luaL_register(L, <span class="hljs-string">"boolarray"</span>, lib);<span class="hljs-comment">//创建名为boolarray的table,并为其添加一个new成员</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
}</code></pre>

<p>编译 <br>
gcc -fpic -shared boolarray.c -o boolarray.so</p>

<p>测试</p>



<pre class="prettyprint"><code class=" hljs livecodeserver"><span class="hljs-built_in">require</span> <span class="hljs-string">"boolarray"</span>
m=boolarray.<span class="hljs-built_in">new</span>(<span class="hljs-number">4</span>)
print(m:size())
m:<span class="hljs-built_in">set</span>(<span class="hljs-number">3</span>,<span class="hljs-constant">true</span>)
m:<span class="hljs-built_in">set</span>(<span class="hljs-number">2</span>,<span class="hljs-constant">false</span>)
print(m:<span class="hljs-built_in">get</span>(<span class="hljs-number">1</span>))
print(m:<span class="hljs-built_in">get</span>(<span class="hljs-number">2</span>))
print(m:<span class="hljs-built_in">get</span>(<span class="hljs-number">3</span>))
print(m:<span class="hljs-built_in">get</span>(<span class="hljs-number">4</span>))</code></pre></div></body>
</html>