<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>寻找中位数（分治+双堆）</title>
<link rel="stylesheet" href="https://stackedit.io/res-min/themes/base.css" />
<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body><div class="container"><p>假如有5亿个int，寻找它们的中位数。</p>

<p>思路是先分治，再用双堆法： <br>
首先将int划分为2^16个区域，然后读取数据统计落到各个区域里的数的个数，之后我们根据统计结果就可以判断中位数落到那个区域。然后第二次扫描我们只统计落在这个区域中的那些数就可以了。</p>

<p>双堆法的思路： <br>
序列中的元素，前一半存储在一个最大堆中，后一半存储在一个最小堆中。控制MaxHeap与MinHeap的大小差不能超过1。具体操作如下：</p>

<pre><code>1.如果 num &lt; MaxHeapTop，则
    1.1 如果 MaxHeapSize &lt;= MinHeapSize，将num插入最大堆；
    1.2 如果 MaxHeapSize &gt;  MinHeapSize，将MaxHeapTop从最大堆中移到最小堆，然后将num插入最大堆。
2.如果 MaxHeapTop &lt;= num &lt;= MinHeapTop，则
    2.1 如果 MaxHeapSize &lt;  MinHeapSize，将num插入最大堆；
    2.2 如果 MaxHeapSize &gt;  MinHeapSize，将num插入最小堆；
    2.3 如果 MaxHeapSize == MinHeapSize，随意插，看心情。
3.如果 num &gt; MinHeapTop，则
    3.1 如果 MaxHeapSize &gt;= MinHeapSize，将num插入最小堆；
    3.2 如果 MaxHeapSize &lt;  MinHeapSize，将MinHeapTop从最小堆中移到最大堆，然后将num插入最小堆。
</code></pre>

<p>上面的插入情况会保证最大堆和最小堆的元素个数差小于1，中位数就只在最大堆和最小堆的顶部元素中产生：如果最大堆和最小堆的元素个数相等，则中位数为最大堆和最小堆的顶部元素的平均值；否则，中位数为元素个数多的那个堆的堆顶元素。</p>

<p>复杂度分析： <br>
最差情况每次都要对堆做3次调整，复杂度为<span class="MathJax_Preview"></span><span class="MathJax" id="MathJax-Element-7-Frame" role="textbox" aria-readonly="true" style=""><nobr><span class="math" id="MathJax-Span-151" style="width: 9.336em; display: inline-block;"><span style="display: inline-block; position: relative; width: 7.469em; height: 0px; font-size: 125%;"><span style="position: absolute; clip: rect(1.496em 1000em 3.203em -0.424em); top: -2.717em; left: 0.003em;"><span class="mrow" id="MathJax-Span-152"><span class="mn" id="MathJax-Span-153" style="font-family: MathJax_Main;">3</span><span class="mo" id="MathJax-Span-154" style="font-family: MathJax_Main; padding-left: 0.216em;">∗</span><span class="mn" id="MathJax-Span-155" style="font-family: MathJax_Main; padding-left: 0.216em;">2</span><span class="mo" id="MathJax-Span-156" style="font-family: MathJax_Main; padding-left: 0.216em;">∗</span><span class="munderover" id="MathJax-Span-157" style="padding-left: 0.216em;"><span style="display: inline-block; position: relative; width: 2.243em; height: 0px;"><span style="position: absolute; clip: rect(1.869em 1000em 3.203em -0.424em); top: -2.771em; left: 0.003em;"><span class="mo" id="MathJax-Span-158" style="font-family: MathJax_Size1; vertical-align: 0.003em;">∑</span><span style="display: inline-block; width: 0px; height: 2.776em;"></span></span><span style="position: absolute; clip: rect(1.816em 1000em 2.829em -0.477em); top: -3.037em; left: 1.069em;"><span class="texatom" id="MathJax-Span-159"><span class="mrow" id="MathJax-Span-160"><span class="mi" id="MathJax-Span-161" style="font-size: 70.7%; font-family: MathJax_Math-italic;">n</span><span class="texatom" id="MathJax-Span-162"><span class="mrow" id="MathJax-Span-163"><span class="mo" id="MathJax-Span-164" style="font-size: 70.7%; font-family: MathJax_Main;">/</span></span></span><span class="mn" id="MathJax-Span-165" style="font-size: 70.7%; font-family: MathJax_Main;">2</span></span></span><span style="display: inline-block; width: 0px; height: 2.509em;"></span></span><span style="position: absolute; clip: rect(1.869em 1000em 2.669em -0.477em); top: -2.184em; left: 1.069em;"><span class="texatom" id="MathJax-Span-166"><span class="mrow" id="MathJax-Span-167"><span class="mi" id="MathJax-Span-168" style="font-size: 70.7%; font-family: MathJax_Math-italic;">i</span><span class="mo" id="MathJax-Span-169" style="font-size: 70.7%; font-family: MathJax_Main;">=</span><span class="mn" id="MathJax-Span-170" style="font-size: 70.7%; font-family: MathJax_Main;">1</span></span></span><span style="display: inline-block; width: 0px; height: 2.509em;"></span></span></span></span><span class="msubsup" id="MathJax-Span-171" style="padding-left: 0.163em;"><span style="display: inline-block; position: relative; width: 1.709em; height: 0px;"><span style="position: absolute; clip: rect(1.869em 1000em 3.096em -0.477em); top: -2.717em; left: 0.003em;"><span class="mi" id="MathJax-Span-172" style="font-family: MathJax_Main;">log</span><span style="display: inline-block; width: 0px; height: 2.723em;"></span></span><span style="position: absolute; top: -2.237em; left: 1.283em;"><span class="mn" id="MathJax-Span-173" style="font-size: 70.7%; font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 2.509em;"></span></span></span></span><span class="mo" id="MathJax-Span-174"></span><span class="mi" id="MathJax-Span-175" style="font-family: MathJax_Math-italic; padding-left: 0.163em;">i</span></span><span style="display: inline-block; width: 0px; height: 2.723em;"></span></span></span><span style="border-left: 0.003em solid; display: inline-block; overflow: hidden; width: 0px; height: 1.87em; vertical-align: -0.463em;"></span></span></nobr></span><script type="math/tex" id="MathJax-Element-7">3*2*\sum_{i=1}^{n/2} \log_2 i</script>。</p>

<p>c++代码：</p>

<pre class="prettyprint"><code class=" hljs cpp"><span class="hljs-keyword">int</span> median_heap(<span class="hljs-keyword">const</span> <span class="hljs-stl_container"><span class="hljs-built_in">vector</span>&lt;<span class="hljs-keyword">int</span>&gt;</span>&amp; arr)
{
    <span class="hljs-keyword">if</span>(arr.empty()) <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
    <span class="hljs-keyword">if</span>(arr.size() == <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> arr[<span class="hljs-number">0</span>];
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(arr.size() == <span class="hljs-number">2</span>) <span class="hljs-keyword">return</span> (arr[<span class="hljs-number">0</span>]+arr[<span class="hljs-number">1</span>])/<span class="hljs-number">2</span>;

    priority_queue&lt;<span class="hljs-keyword">int</span>&gt; maxheap;
    priority_queue&lt;<span class="hljs-keyword">int</span>, <span class="hljs-stl_container"><span class="hljs-built_in">vector</span>&lt;<span class="hljs-keyword">int</span>&gt;</span>, greater&lt;<span class="hljs-keyword">int</span>&gt;&gt; minheap;
    maxheap.push(min(arr[<span class="hljs-number">0</span>],arr[<span class="hljs-number">1</span>]));
    minheap.push(max(arr[<span class="hljs-number">0</span>],arr[<span class="hljs-number">1</span>]));

    <span class="hljs-keyword">auto</span> i=arr.begin()+<span class="hljs-number">2</span>;
    <span class="hljs-keyword">for</span>(;i!=arr.end();++i)
    {
        <span class="hljs-comment">// 应放入maxheap</span>
        <span class="hljs-keyword">if</span>(*i &lt; maxheap.top())
        {
            <span class="hljs-keyword">if</span>(maxheap.size() &gt; minheap.size())
            {
                minheap.push(maxheap.top());
                maxheap.pop();
            }
            maxheap.push(*i);
        }
        <span class="hljs-comment">// 应放入minheap</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(*i &gt; minheap.top())
        {
            <span class="hljs-keyword">if</span>(maxheap.size() &lt; minheap.size())
            {
                maxheap.push(minheap.top());
                minheap.pop();
            }
            minheap.push(*i);
        }
        <span class="hljs-keyword">else</span>
        {
            <span class="hljs-keyword">if</span>(maxheap.size() &lt; minheap.size())
                maxheap.push(*i);
            <span class="hljs-keyword">else</span>
                minheap.push(*i);
        }
    }

    <span class="hljs-keyword">if</span>(maxheap.size() &gt; minheap.size())
        <span class="hljs-keyword">return</span> maxheap.top();
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(maxheap.size() &lt; minheap.size())
        <span class="hljs-keyword">return</span> minheap.top();
    <span class="hljs-keyword">return</span> (maxheap.top()+minheap.top())/<span class="hljs-number">2</span>;
}</code></pre>

<p>参考 <br>
<a href="http://blog.csdn.net/v_july_v/article/details/6279498">十道海量数据处理面试题与十个方法大总结</a> <br>
<a href="http://www.cnblogs.com/lienhua34/archive/2011/12/06/2381299.html">利用最大堆和最小堆在线寻找中位数</a></p></div></body>
</html>