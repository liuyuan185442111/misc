<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Java Web入门之jsp要点</title>
<link rel="stylesheet" href="https://stackedit.io/res-min/themes/base.css" />
<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body><div class="container"><h2 id="一-基本">一. 基本</h2>



<h3 id="第一次请求jsp页面的执行过程">第一次请求JSP页面的执行过程</h3>

<p><!--&#22823;&#22270;&#22312;&#36825;http://img.blog.csdn.net/20150414123512409--><img src="http://img.blog.csdn.net/20150419233801853" alt="第一次请求JSP页面的执行过程" title=""></p>



<h3 id="jsp标签说明">jsp标签说明</h3>

<table>
<thead>
<tr>
  <th>JSP元素</th>
  <th>表达形式</th>
</tr>
</thead>
<tbody><tr>
  <td>表达式</td>
  <td>&lt;%= 表达式 %&gt;</td>
</tr>
<tr>
  <td>程序段</td>
  <td>&lt;% java代码段 %&gt;</td>
</tr>
<tr>
  <td>声明</td>
  <td>&lt;%! java变量或方法声明 %&gt;</td>
</tr>
<tr>
  <td>注释</td>
  <td>&lt;%– 注释内容 –%&gt;</td>
</tr>
<tr>
  <td>(编译)指令</td>
  <td>&lt;%@ … %&gt;</td>
</tr>
<tr>
  <td>动作(指令)</td>
  <td>&lt;% jsp:动作… %&gt;</td>
</tr>
</tbody></table>




<h3 id="一个简单的例子">一个简单的例子</h3>

<p>first.jsp</p>

<pre class="prettyprint"><code class="language-jsp hljs xml"><span class="vbscript">&lt;%@ page language=<span class="hljs-string">"java"</span> %&gt;</span>
<span class="vbscript">&lt;%@ page contentType=<span class="hljs-string">"text/html;charset=UTF-8"</span> pageEncoding=<span class="hljs-string">"utf-8"</span> %&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">title</span>&gt;</span>first jsp page<span class="hljs-tag">&lt;/<span class="hljs-title">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">body</span>&gt;</span>
    <span class="vbscript">&lt;%!
    <span class="hljs-built_in">int</span> count = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> add(<span class="hljs-built_in">int</span> a, <span class="hljs-built_in">int</span> b)
    {
        return a+b;
    }
    %&gt;</span>
    count = <span class="vbscript">&lt;%=count++%&gt;</span><span class="hljs-tag">&lt;<span class="hljs-title">br</span>&gt;</span>
    <span class="vbscript">&lt;%
    <span class="hljs-built_in">String</span> welcome = <span class="hljs-string">"WELCOME"</span>;
    <span class="hljs-built_in">int</span> font = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">7</span>; ++i) {%&gt;</span><span class="hljs-tag">&lt;<span class="hljs-title">font</span> <span class="hljs-attribute">size</span>=<span class="hljs-value">&lt;%=++font%</span>&gt;</span>&gt;<span class="vbscript">&lt;%=welcome.charAt(i)%&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">font</span>&gt;</span><span class="vbscript">&lt;%}%&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">html</span>&gt;</span></code></pre>

<p>被jsp引擎翻译成的java代码（tomcat 7）first_jsp.java</p>



<pre class="prettyprint"><code class="language-java hljs "><span class="hljs-comment">/*
 * Generated by the Jasper component of Apache Tomcat
 * Version: Apache Tomcat/7.0.59
 * Generated at: 2015-04-14 05:30:40 UTC
 * Note: The last modified time of this file was set to
 *       the last modified time of the source file after
 *       generation to assist with modification tracking.
 */</span>
<span class="hljs-keyword">package</span> org.apache.jsp;

<span class="hljs-keyword">import</span> javax.servlet.*;
<span class="hljs-keyword">import</span> javax.servlet.http.*;
<span class="hljs-keyword">import</span> javax.servlet.jsp.*;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">first_jsp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">org</span>.<span class="hljs-title">apache</span>.<span class="hljs-title">jasper</span>.<span class="hljs-title">runtime</span>.<span class="hljs-title">HttpJspBase</span>
    <span class="hljs-keyword">implements</span> <span class="hljs-title">org</span>.<span class="hljs-title">apache</span>.<span class="hljs-title">jasper</span>.<span class="hljs-title">runtime</span>.<span class="hljs-title">JspSourceDependent</span> {</span>

    <span class="hljs-keyword">int</span> count = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">add</span>(<span class="hljs-keyword">int</span> a, <span class="hljs-keyword">int</span> b)
    {
        <span class="hljs-keyword">return</span> a+b;
    }

  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> javax.servlet.jsp.JspFactory _jspxFactory =
          javax.servlet.jsp.JspFactory.getDefaultFactory();

  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> java.util.Map&lt;java.lang.String,java.lang.Long&gt; _jspx_dependants;

  <span class="hljs-keyword">private</span> javax.el.ExpressionFactory _el_expressionfactory;
  <span class="hljs-keyword">private</span> org.apache.tomcat.InstanceManager _jsp_instancemanager;

  <span class="hljs-keyword">public</span> java.util.Map&lt;java.lang.String,java.lang.Long&gt; <span class="hljs-title">getDependants</span>() {
    <span class="hljs-keyword">return</span> _jspx_dependants;
  }

  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">_jspInit</span>() {
    _el_expressionfactory = _jspxFactory.getJspApplicationContext(getServletConfig().getServletContext()).getExpressionFactory();
    _jsp_instancemanager = org.apache.jasper.runtime.InstanceManagerFactory.getInstanceManager(getServletConfig());
  }

  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">_jspDestroy</span>() {
  }

  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">_jspService</span>(<span class="hljs-keyword">final</span> javax.servlet.http.HttpServletRequest request, <span class="hljs-keyword">final</span> javax.servlet.http.HttpServletResponse response)
        <span class="hljs-keyword">throws</span> java.io.IOException, javax.servlet.ServletException {

    <span class="hljs-keyword">final</span> javax.servlet.jsp.PageContext pageContext;
    javax.servlet.http.HttpSession session = <span class="hljs-keyword">null</span>;
    <span class="hljs-keyword">final</span> javax.servlet.ServletContext application;
    <span class="hljs-keyword">final</span> javax.servlet.ServletConfig config;
    javax.servlet.jsp.JspWriter out = <span class="hljs-keyword">null</span>;
    <span class="hljs-keyword">final</span> java.lang.Object page = <span class="hljs-keyword">this</span>;
    javax.servlet.jsp.JspWriter _jspx_out = <span class="hljs-keyword">null</span>;
    javax.servlet.jsp.PageContext _jspx_page_context = <span class="hljs-keyword">null</span>;


    <span class="hljs-keyword">try</span> {
      response.setContentType(<span class="hljs-string">"text/html;charset=UTF-8"</span>);
      pageContext = _jspxFactory.getPageContext(<span class="hljs-keyword">this</span>, request, response, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">true</span>, <span class="hljs-number">8192</span>, <span class="hljs-keyword">true</span>);
      _jspx_page_context = pageContext;
      application = pageContext.getServletContext();
      config = pageContext.getServletConfig();
      session = pageContext.getSession();
      out = pageContext.getOut();
      _jspx_out = out;

      out.write(<span class="hljs-string">"\r\n"</span>);
      out.write(<span class="hljs-string">"\r\n"</span>);
      out.write(<span class="hljs-string">"&lt;html&gt;\r\n"</span>);
      out.write(<span class="hljs-string">"&lt;head&gt;\r\n"</span>);
      out.write(<span class="hljs-string">"\t&lt;title&gt;first&lt;/title&gt;\r\n"</span>);
      out.write(<span class="hljs-string">"&lt;/head&gt;\r\n"</span>);
      out.write(<span class="hljs-string">"&lt;body&gt;\r\n"</span>);
      out.write(<span class="hljs-string">"\t"</span>);
      out.write(<span class="hljs-string">"\r\n"</span>);
      out.write(<span class="hljs-string">"\tcount = "</span>);
      out.print(count++);
      out.write(<span class="hljs-string">"&lt;br&gt;\r\n"</span>);
      out.write(<span class="hljs-string">"\t"</span>);

    String welcome = <span class="hljs-string">"WELCOME"</span>;
    <span class="hljs-keyword">int</span> font = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">7</span>; ++i) {
      out.write(<span class="hljs-string">"&lt;font size="</span>);
      out.print(++font);
      out.write(<span class="hljs-string">'&gt;'</span>);
      out.print(welcome.charAt(i));
      out.write(<span class="hljs-string">"&lt;/font&gt;"</span>);
      }
      out.write(<span class="hljs-string">"\r\n"</span>);
      out.write(<span class="hljs-string">"&lt;/body&gt;\r\n"</span>);
      out.write(<span class="hljs-string">"&lt;/html&gt;"</span>);
    } <span class="hljs-keyword">catch</span> (java.lang.Throwable t) {
      <span class="hljs-keyword">if</span> (!(t <span class="hljs-keyword">instanceof</span> javax.servlet.jsp.SkipPageException)){
        out = _jspx_out;
        <span class="hljs-keyword">if</span> (out != <span class="hljs-keyword">null</span> &amp;&amp; out.getBufferSize() != <span class="hljs-number">0</span>)
          <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">if</span> (response.isCommitted()) {
              out.flush();
            } <span class="hljs-keyword">else</span> {
              out.clearBuffer();
            }
          } <span class="hljs-keyword">catch</span> (java.io.IOException e) {}
        <span class="hljs-keyword">if</span> (_jspx_page_context != <span class="hljs-keyword">null</span>) _jspx_page_context.handlePageException(t);
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ServletException(t);
      }
    } <span class="hljs-keyword">finally</span> {
      _jspxFactory.releasePageContext(_jspx_page_context);
    }
  }
}</code></pre>

<p>对比之下可发现，<code>&lt;%! %&gt;</code>标签内定义的变量和方法成为了类的成员变量和成员方法，<code>&lt;% %&gt;</code>标签内定义的变量成为了_jspService函数的局部变量。而且访问first.jsp的时候，count会一直增加，即使更换浏览器后继续访问，这说明tomcat在生成这个类的实例之后，会一直存储着，直到tomcat关闭。所以<code>&lt;%! %&gt;</code>标签内定义的变量和方法加不加static关键字都是无所谓的。</p>

<p>java代码中的out.print()和out.write()，作用都是输出字符串，不同之处是： <br>
out.print()方法，将各种数据转换成字符串的形式输出，参数是一个java对象；  <br>
out.write()方法，参数必须是字符／字符数组／字符串等与字符相关的数据。</p>



<h3 id="参考">参考</h3>

<p>JSP起源、JSP的运行原理、JSP的执行过程 <br>
<a href="http://blog.csdn.net/fengdongkun/article/details/8159381" target="_blank">http://blog.csdn.net/fengdongkun/article/details/8159381</a> <br>
out.print和out.write <br>
<a href="http://lixh1986.iteye.com/blog/1757126" target="_blank">http://lixh1986.iteye.com/blog/1757126</a></p>



<h2 id="二-编译指令">二. 编译指令</h2>

<p>编译指令用来告诉引擎如何处理jsp页面中的某些部分。 <br>
基本语法格式是<code>&lt;%@ 编译指令名 属性名="属性值" %&gt;</code>，属性名区分大小写。 <br>
1. page <br>
用来设置整个jsp页面的相关属性和功能 <br>
2. include <br>
用于通知jsp引擎在翻译当前jsp页面时将其他文件中的内容与当前jsp页面合并，转换成一个Servlet源文件 <br>
3. taglib <br>
引入一个标签库或自定义标签，并定义它们的前缀</p>



<h2 id="三-动作指令">三. 动作指令</h2>

<p>动作指令是动态执行的指令，运行时的脚本动作。 <br>
1. jsp:include <br>
用于动态引入一个jsp页面 <br>
2. jsp:useBean动作 <br>
使用JavaBean <br>
3. jsp:getProperty <br>
获取JavaBean实例的属性值 <br>
4. jsp:setProperty <br>
修改JavaBean实例的属性值 <br>
5. jsp:forward <br>
执行页面转向，将请求的处理转发到下一个页面 <br>
6. jsp:param <br>
用于传递参数，必须与其他支持参数的标记一起使用 <br>
7. jsp:plugin <br>
用于下载JavaBean或Applet到客户端执行</p>



<h2 id="四-隐含对象">四. 隐含对象</h2>

<p>jsp文件中共有9个隐含的java对象，其中8个在上边的java代码里已有体现，6个在_jspService函数里定义，request和response是_jspService的参数。 <br>
至于exception对象，当jsp页面用</p>

<pre><code>&lt;%@ page isErrorPage="true" %&gt;
</code></pre>

<p>被指定为errorPage后，_jspService也会定义exception对象，如下：</p>

<pre class="prettyprint"><code class="language-java hljs ">    <span class="hljs-keyword">final</span> javax.servlet.jsp.PageContext pageContext;
    javax.servlet.http.HttpSession session = <span class="hljs-keyword">null</span>;
    java.lang.Throwable exception = org.apache.jasper.runtime.JspRuntimeLibrary.getThrowable(request);
    <span class="hljs-keyword">if</span> (exception != <span class="hljs-keyword">null</span>) {
        response.setStatus(javax.servlet.http.HttpServletResponse.SC_INTERNAL_SERVER_ERROR);
    }
    <span class="hljs-keyword">final</span> javax.servlet.ServletContext application;
    <span class="hljs-keyword">final</span> javax.servlet.ServletConfig config;
    javax.servlet.jsp.JspWriter out = <span class="hljs-keyword">null</span>;
    <span class="hljs-keyword">final</span> java.lang.Object page = <span class="hljs-keyword">this</span>;</code></pre>

<p>pageContext由request和response得到，page就是对象本身，其他对象都由pageContext得到。</p>

<p>这9个隐含对象分别为：</p>

<table>
<thead>
<tr>
  <th>对象</th>
  <th>说明</th>
</tr>
</thead>
<tbody><tr>
  <td>page</td>
  <td>代表当前页面</td>
</tr>
<tr>
  <td>request</td>
  <td>代表由用户提交请求而触发的request对象</td>
</tr>
<tr>
  <td>response</td>
  <td>代表由用户提交请求而触发的response对象</td>
</tr>
<tr>
  <td>pageContext</td>
  <td>提供了对JSP页面内所有的对象及名字空间的访问</td>
</tr>
<tr>
  <td>session</td>
  <td>代表会话对象，在发生HTTP请求时被创建</td>
</tr>
<tr>
  <td>application</td>
  <td></td>
</tr>
<tr>
  <td>out</td>
  <td>主要用来向客户端输出内容，同时管理应用服务器输出缓冲区</td>
</tr>
<tr>
  <td>config</td>
  <td>代表当前页面配置</td>
</tr>
<tr>
  <td>exception</td>
  <td>代表异常</td>
</tr>
</tbody></table>




<h3 id="cookie对象">Cookie对象</h3>

<p>它不是jsp的内置对象，但它很有用，一般和session配合使用，使用它时需要显式创建。 <br>
Cookie类有如下几个方法：</p>

<pre class="prettyprint"><code class=" hljs bash"><span class="hljs-keyword">set</span>MaxAge(int expiry);
设置Cookie的存在时间，正值表示Cookie将在多少秒后失效，负值表示当浏览器关闭时，Cookie将被删除，零值表示要删除该Cookie。
<span class="hljs-keyword">set</span>Domain(String domain);
设置Cookie在哪个域名下可见。
<span class="hljs-keyword">set</span>Path(String path);
设置Cookie在当前域名的哪个路径下可见，如果设置为<span class="hljs-string">"/"</span>则在当前域名下的所有路径均可见。
如果未设置，则在哪个页面产生的就只能在哪个页面访问。
Cookie[] getCookies();
获得Cookie数组。</code></pre>

<p>将cookie存储到客户端的方法是：</p>

<pre class="prettyprint"><code class="language-java hljs ">    Cookie cookie = <span class="hljs-keyword">new</span> Cookie(<span class="hljs-string">"username"</span>, <span class="hljs-string">"jack"</span>);
    cookie.setMaxAge(<span class="hljs-number">60</span>*<span class="hljs-number">60</span>);<span class="hljs-comment">//设定存活期为1小时</span>
    cookie.setDomain(<span class="hljs-string">".csdn.net"</span>);
    cookie.setPath(<span class="hljs-string">"/"</span>);
    response.addCookie(cookie);</code></pre>

<p>读取客户端cookie的方法是：</p>



<pre class="prettyprint"><code class="language-java hljs ">    <span class="hljs-keyword">if</span>(request.getCookies()!=<span class="hljs-keyword">null</span>)
    {
        <span class="hljs-keyword">for</span>(Cookie cookie:request.getCookies())
        {
            String name = cookie.getName();
            String value = cookie.getValue();
            out.println(name+<span class="hljs-string">"+"</span>+value+<span class="hljs-string">"&lt;br&gt;"</span>);
        }
    }</code></pre>



<h2 id="五-乱码问题">五. 乱码问题</h2>



<h3 id="文件编码">文件编码</h3>

<p><code>&lt;%@ page contentType="text/html;charset=gbk" pageEncoding="utf-8" %&gt;</code> <br>
里的pageEncoding是jsp文件本身的编码，contentType是指服务器发送给客户端的html的编码，它必须和html代码里的 <br>
<code>&lt;meta http-equiv=Content-Type content="text/html;charset=gbk"&gt;</code> <br>
设置相符合才行。</p>



<h3 id="表单提交">表单提交</h3>

<p>在提交表单时（get或post方法），使用request.getParameter方法获取表单控件值时可能会出现乱码。 <br>
1. get方法 <br>
get方法传的参数可能使用了ISO-8859-1编码，在服务器端可以先获取字符串的字节码，然后再转换为支持中文的编码：</p>

<pre><code>String newstrig = new String(oldstring.getBytes("ISO-8859-1"), "utf-8");
</code></pre>

<p>也可以在tomcat的配置文件$TOMCAT/conf/server.xml里的将URIEncoding改为utf-8：</p>

<pre class="prettyprint"><code class="language-xml hljs "><span class="hljs-tag">&lt;<span class="hljs-title">Connector</span> <span class="hljs-attribute">port</span>=<span class="hljs-value">"8080"</span> <span class="hljs-attribute">protocol</span>=<span class="hljs-value">"HTTP/1.1"</span> <span class="hljs-attribute">connectionTimeout</span>=<span class="hljs-value">"20000"</span> <span class="hljs-attribute">redirectPort</span>=<span class="hljs-value">"8443"</span> <span class="hljs-attribute">URIEncoding</span>=<span class="hljs-value">"utf-8"</span> /&gt;</span></code></pre>

<p>然后重启tomcat就可以正确处理get方法提交的数据了。 <br>
2. post方法 <br>
如果html页面用的是utf-8编码，可以在处理页面通过设置</p>

<pre><code>request.setCharacterEncoding("utf-8");
</code></pre>

<p>来解决，功能是设置请求对象的字符编码。如果html页面用的是gbk编码，将utf-8改成gbk即可。 <br>
<code>response.setCharacterEncoding("utf-8")</code>用来设置回应信息的字符编码。 <br>
可以编写一个过滤器，来执行这个设置，这样就不用在每个页面都加上这条语句了。</p>

<p>当然，也可以仿照get方法的处理方法：</p>

<pre><code>String user0 = request.getParameter("user");
String user = new String(user0.getBytes("ISO-8859-1"), "utf-8");
</code></pre></div></body>
</html>