<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Java Web入门之生成一个验证码图片</title>
<link rel="stylesheet" href="https://stackedit.io/res-min/themes/base.css" />
<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body><div class="container"><p>用java产生一个验证码图片的代码如下：</p>

<pre class="prettyprint"><code class="language-java hljs "><span class="hljs-keyword">import</span> java.awt.Color;
<span class="hljs-keyword">import</span> java.awt.Font;
<span class="hljs-keyword">import</span> java.awt.Graphics;
<span class="hljs-keyword">import</span> java.awt.image.BufferedImage;
<span class="hljs-keyword">import</span> java.io.File;
<span class="hljs-keyword">import</span> java.io.IOException;
<span class="hljs-keyword">import</span> java.util.Random;
<span class="hljs-keyword">import</span> javax.imageio.ImageIO;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">IdentifyingImage</span>
{</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> width = <span class="hljs-number">80</span>, height = <span class="hljs-number">27</span>;
    <span class="hljs-keyword">static</span>  <span class="hljs-keyword">private</span> Random random = <span class="hljs-keyword">new</span> Random();
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">private</span> Font font = <span class="hljs-keyword">new</span> Font(<span class="hljs-string">"Comic Sans"</span>, Font.BOLD|Font.ITALIC, <span class="hljs-number">24</span>);

    <span class="hljs-keyword">static</span> <span class="hljs-keyword">private</span> Color <span class="hljs-title">getRandomColor</span>()
    {
        <span class="hljs-keyword">int</span> r = random.nextInt(<span class="hljs-number">255</span>);
        <span class="hljs-keyword">int</span> g = random.nextInt(<span class="hljs-number">255</span>);
        <span class="hljs-keyword">int</span> b = random.nextInt(<span class="hljs-number">255</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Color(r, g, b);
    }

    <span class="hljs-keyword">static</span> <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">getItem</span>()
    {
        <span class="hljs-comment">//创建一个图片缓冲区</span>
        BufferedImage image = <span class="hljs-keyword">new</span> BufferedImage(width, height, BufferedImage.TYPE_INT_RGB);
        <span class="hljs-comment">//获取图片处理对象</span>
        Graphics graphics = image.getGraphics();
        <span class="hljs-comment">//填充背景色</span>
        graphics.setColor(getRandomColor());
        graphics.fillRect(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height);
        <span class="hljs-comment">//设定边框颜色</span>
        graphics.setColor(getRandomColor());
        graphics.drawRect(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width-<span class="hljs-number">1</span>, height-<span class="hljs-number">1</span>);
        <span class="hljs-comment">//设置干扰线</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">10</span>; ++i)
        {
            <span class="hljs-keyword">int</span> x1 = random.nextInt(width-<span class="hljs-number">2</span>);
            <span class="hljs-keyword">int</span> y1 = random.nextInt(height-<span class="hljs-number">2</span>);
            <span class="hljs-keyword">int</span> x2 = random.nextInt(width-<span class="hljs-number">2</span>);
            <span class="hljs-keyword">int</span> y2 = random.nextInt(height-<span class="hljs-number">2</span>);
            graphics.setColor(getRandomColor());
            graphics.drawLine(x1+<span class="hljs-number">1</span>, y1+<span class="hljs-number">1</span>, x2+<span class="hljs-number">1</span>, y2+<span class="hljs-number">1</span>);
        }
        <span class="hljs-comment">//写入文字</span>
        StringBuffer strbuf = <span class="hljs-keyword">new</span> StringBuffer(<span class="hljs-string">""</span>);
        graphics.setFont(font);
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">4</span>; ++i)
        {
            graphics.setColor(getRandomColor());
            <span class="hljs-keyword">int</span> n = random.nextInt(<span class="hljs-number">10</span>);
            strbuf.append(n);
            graphics.drawString(<span class="hljs-string">""</span>+n, <span class="hljs-number">1</span>+<span class="hljs-number">20</span>*i, height-<span class="hljs-number">4</span>);
        }

        <span class="hljs-comment">//输出文件</span>
        File file = <span class="hljs-keyword">new</span> File(<span class="hljs-string">"D:\\123.gif"</span>);
        <span class="hljs-keyword">try</span>
        {
            ImageIO.write(image, <span class="hljs-string">"GIF"</span>, file);
        }
        <span class="hljs-keyword">catch</span> (IOException e)
        {
            e.printStackTrace();
        }

        <span class="hljs-comment">//释放资源</span>
        graphics.dispose();
    }


    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(String[] args)
    {
        IdentifyingImage.getItem();
    }
}</code></pre>

<p>下面就做一个带验证码的简单登陆界面。</p>

<p>先将上面的类封装为一个JavaBean：</p>

<pre class="prettyprint"><code class="language-java hljs "><span class="hljs-keyword">package</span> advance;

<span class="hljs-keyword">import</span> java.awt.Color;
<span class="hljs-keyword">import</span> java.awt.Font;
<span class="hljs-keyword">import</span> java.awt.Graphics;
<span class="hljs-keyword">import</span> java.awt.image.BufferedImage;
<span class="hljs-keyword">import</span> java.io.File;
<span class="hljs-keyword">import</span> java.io.IOException;
<span class="hljs-keyword">import</span> java.util.Random;
<span class="hljs-keyword">import</span> javax.imageio.ImageIO;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">IdentifyingImage</span>
{</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> width = <span class="hljs-number">78</span>, height = <span class="hljs-number">27</span>;
    <span class="hljs-keyword">static</span>  <span class="hljs-keyword">private</span> Random random = <span class="hljs-keyword">new</span> Random();
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">private</span> Font font = <span class="hljs-keyword">new</span> Font(<span class="hljs-string">"Comic Sans"</span>, Font.BOLD|Font.ITALIC, <span class="hljs-number">24</span>);

    <span class="hljs-keyword">static</span> <span class="hljs-keyword">private</span> Color <span class="hljs-title">getRandomColor</span>()
    {
        <span class="hljs-keyword">int</span> r = random.nextInt(<span class="hljs-number">255</span>);
        <span class="hljs-keyword">int</span> g = random.nextInt(<span class="hljs-number">255</span>);
        <span class="hljs-keyword">int</span> b = random.nextInt(<span class="hljs-number">255</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Color(r, g, b);
    }

    <span class="hljs-keyword">static</span> <span class="hljs-keyword">public</span> BufferedImage <span class="hljs-title">getItem</span>(String s)
    {
        BufferedImage image = <span class="hljs-keyword">new</span> BufferedImage(width, height, BufferedImage.TYPE_INT_RGB);
        Graphics graphics = image.getGraphics();
        graphics.setColor(getRandomColor());
        graphics.fillRect(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height);
        graphics.setColor(getRandomColor());
        graphics.drawRect(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width-<span class="hljs-number">1</span>, height-<span class="hljs-number">1</span>);
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">10</span>; ++i)
        {
            <span class="hljs-keyword">int</span> x1 = random.nextInt(width-<span class="hljs-number">2</span>);
            <span class="hljs-keyword">int</span> y1 = random.nextInt(height-<span class="hljs-number">2</span>);
            <span class="hljs-keyword">int</span> x2 = random.nextInt(width-<span class="hljs-number">2</span>);
            <span class="hljs-keyword">int</span> y2 = random.nextInt(height-<span class="hljs-number">2</span>);
            graphics.setColor(getRandomColor());
            graphics.drawLine(x1+<span class="hljs-number">1</span>, y1+<span class="hljs-number">1</span>, x2+<span class="hljs-number">1</span>, y2+<span class="hljs-number">1</span>);
        }
        graphics.setFont(font);
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">4</span>; ++i)
        {
            graphics.setColor(getRandomColor());
            <span class="hljs-keyword">int</span> n = random.nextInt(<span class="hljs-number">10</span>);
            graphics.drawString(<span class="hljs-string">""</span>+s.charAt(i), <span class="hljs-number">2</span>+<span class="hljs-number">20</span>*i, height-<span class="hljs-number">4</span>);
        }
        graphics.dispose();
        <span class="hljs-keyword">return</span> image;
    }
}</code></pre>

<p>然后编写将验证码传至客户端的Servlet，将验证码信息放到了session里，以备验证。</p>

<pre class="prettyprint"><code class="language-java hljs "><span class="hljs-keyword">package</span> advance;

<span class="hljs-keyword">import</span> java.awt.image.BufferedImage;
<span class="hljs-keyword">import</span> java.io.IOException;
<span class="hljs-keyword">import</span> java.util.Random;
<span class="hljs-keyword">import</span> javax.imageio.ImageIO;
<span class="hljs-keyword">import</span> javax.servlet.ServletException;
<span class="hljs-keyword">import</span> javax.servlet.http.HttpServlet;
<span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;
<span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;
<span class="hljs-keyword">import</span> javax.servlet.http.HttpSession;

<span class="hljs-keyword">import</span> advance.IdentifyingImage;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GenImage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">HttpServlet</span>
{</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title">GenImage</span>()
    {
        <span class="hljs-keyword">super</span>();
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">destroy</span>()
    {
        <span class="hljs-keyword">super</span>.destroy();
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doGet</span>(HttpServletRequest request, HttpServletResponse response) <span class="hljs-keyword">throws</span> IOException, ServletException
    {
        String code=<span class="hljs-string">""</span>;
        Random rm = <span class="hljs-keyword">new</span> Random();
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">4</span>; ++i) code += rm.nextInt(<span class="hljs-number">10</span>);
        HttpSession session = request.getSession();
        session.setAttribute(<span class="hljs-string">"piccode"</span>,code);
        <span class="hljs-comment">//禁止缓存</span>
        response.setHeader(<span class="hljs-string">"Prama"</span>,<span class="hljs-string">"no-cache"</span>);
        response.setHeader(<span class="hljs-string">"Cache-Control"</span>,<span class="hljs-string">"no-cache"</span>);
        response.setDateHeader(<span class="hljs-string">"Expires"</span>,<span class="hljs-number">0</span>);
        response.setContentType(<span class="hljs-string">"image/gif"</span>);
        ImageIO.write(IdentifyingImage.getItem(code), <span class="hljs-string">"gif"</span>, response.getOutputStream());
        response.getOutputStream().close();
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doPost</span>(HttpServletRequest request, HttpServletResponse response) <span class="hljs-keyword">throws</span> IOException, ServletException
    {
        doGet(request, response);
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init</span>() <span class="hljs-keyword">throws</span> ServletException {}
}</code></pre>

<p>web.xml配置</p>



<pre class="prettyprint"><code class="language-xml hljs "><span class="hljs-tag">&lt;<span class="hljs-title">servlet</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">servlet-name</span>&gt;</span>image<span class="hljs-tag">&lt;/<span class="hljs-title">servlet-name</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">servlet-class</span>&gt;</span>advance.GenImage<span class="hljs-tag">&lt;/<span class="hljs-title">servlet-class</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">servlet</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">servlet-mapping</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">servlet-name</span>&gt;</span>image<span class="hljs-tag">&lt;/<span class="hljs-title">servlet-name</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">url-pattern</span>&gt;</span>/image<span class="hljs-tag">&lt;/<span class="hljs-title">url-pattern</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">servlet-mapping</span>&gt;</span></code></pre>

<p>登陆界面 login.html：</p>

<pre class="prettyprint"><code class="language-jsp hljs xml"><span class="hljs-tag">&lt;<span class="hljs-title">html</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">meta</span> <span class="hljs-attribute">http-equiv</span>=<span class="hljs-value">Content-Type</span> <span class="hljs-attribute">content</span>=<span class="hljs-value">"text/html;charset=utf-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">script</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"text/javascript"</span>&gt;</span><span class="javascript">
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">reloadImage</span><span class="hljs-params">(t)</span> {</span>
        t.src=<span class="hljs-string">"image?flag="</span>+<span class="hljs-built_in">Math</span>.random();
    }
    </span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">title</span>&gt;</span>login<span class="hljs-tag">&lt;/<span class="hljs-title">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">form</span> <span class="hljs-attribute">action</span>=<span class="hljs-value">"check.jsp"</span> <span class="hljs-attribute">method</span>=<span class="hljs-value">"post"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">input</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"text"</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"checkcode"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">img</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"image"</span> <span class="hljs-attribute">onclick</span>=<span class="hljs-value">"reloadImage(this)"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-title">br</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">input</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"submit"</span> <span class="hljs-attribute">value</span>=<span class="hljs-value">"登陆"</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-title">form</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">html</span>&gt;</span></code></pre>

<p>验证页面 check.jsp，从session取得正确的验证码，从request参数中取得输入的验证码：</p>

<pre class="prettyprint"><code class="language-java hljs ">&lt;%@ page contentType=<span class="hljs-string">"text/html;charset=UTF-8"</span> pageEncoding=<span class="hljs-string">"utf-8"</span> %&gt;
&lt;html&gt;
    &lt;meta http-equiv=Content-Type content=<span class="hljs-string">"text/html;charset=utf-8"</span>&gt;
&lt;head&gt;
    &lt;title&gt;check&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;%
    String checkcode=request.getParameter(<span class="hljs-string">"checkcode"</span>);
    String piccode=<span class="hljs-keyword">new</span> String();
    Object o = session.getAttribute(<span class="hljs-string">"piccode"</span>);
    <span class="hljs-keyword">if</span>(o != <span class="hljs-keyword">null</span>) piccode=o.toString();
    <span class="hljs-keyword">else</span> piccode=<span class="hljs-string">"木有取到"</span>;
    %&gt;
    你输入的验证码是: &lt;%=checkcode%&gt;&lt;br&gt;
    正确的验证码是: &lt;%=piccode%&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre></div></body>
</html>