<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Java Web入门之监听session的销毁</title>
<link rel="stylesheet" href="https://stackedit.io/res-min/themes/base.css" />
<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body><div class="container"><p>统计在线用户数等功能需要监听session的销毁，有两种方式： <br>
1. 使用HttpSessionListener监听session的销毁。 <br>
2. 使用HttpSessionBindingListener监听session的销毁。</p>



<h2 id="使用httpsessionlistener">使用HttpSessionListener</h2>

<p>编写一个OnlineUserListener：</p>

<pre class="prettyprint"><code class="language-java hljs "><span class="hljs-keyword">package</span> advance;

<span class="hljs-keyword">import</span> java.util.List;
<span class="hljs-keyword">import</span> javax.servlet.ServletContext;
<span class="hljs-keyword">import</span> javax.servlet.http.HttpSession;
<span class="hljs-keyword">import</span> javax.servlet.http.HttpSessionListener;
<span class="hljs-keyword">import</span> javax.servlet.http.HttpSessionEvent;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OnlineUserListener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">HttpSessionListener</span> {</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sessionCreated</span>(HttpSessionEvent event) {}
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sessionDestroyed</span>(HttpSessionEvent event) {
        HttpSession session = event.getSession();
        ServletContext application = session.getServletContext();
        <span class="hljs-comment">// 取得登录的用户名</span>
        String username = (String)session.getAttribute(<span class="hljs-string">"username"</span>);
        <span class="hljs-comment">// 从在线列表中删除用户名</span>
        List onlineUserList = (List)application.getAttribute(<span class="hljs-string">"onlineUserList"</span>);
        onlineUserList.remove(username);
        System.out.println(username + <span class="hljs-string">"超时退出"</span>);
    }
}</code></pre>

<p>为了让监听器发挥作用，将它添加到web.xml中：</p>



<pre class="prettyprint"><code class="language-xml hljs ">    <span class="hljs-tag">&lt;<span class="hljs-title">listener</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">listener-class</span>&gt;</span>advance.OnlineUserListener<span class="hljs-tag">&lt;/<span class="hljs-title">listener-class</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-title">listener</span>&gt;</span></code></pre>

<p>以下两种情况下就会发生sessionDestoryed（会话销毁）事件： <br>
1.执行session.invalidate()方法时。 <br>
2.如果用户长时间没有访问服务器，超过了会话最大超时时间，服务器就会自动销毁超时的session。</p>



<h2 id="jsp中设置session有效时间的三种方式">JSP中设置Session有效时间的三种方式</h2>

<p>（1）在主页面或者公共页面中加入：</p>

<pre><code>HttpSession session = request.getSession(true);  
session.setMaxInactiveInterval(900);
</code></pre>

<p>单位是秒，即在没有活动15分钟后，session将失效。这里要注意这个session设置的时间是根据服务器来计算的，而不是客户端。 <br>
（2）在项目的web.xml中设置</p>

<pre><code>&lt;session-config&gt;
    &lt;session-timeout&gt;15&lt;/session-timeout&gt;
&lt;/session-config&gt;
</code></pre>

<p>单位是分钟。 <br>
（3）直接在应用服务器中设置，如果是tomcat，可以在tomcat目录下conf/web.xml中找到<code>&lt;session-config&gt;</code>元素，tomcat默认设置是30分钟，只要修改这个值就可以了。</p>

<p>优先级：(1)&gt;(2)&gt;(3)</p>



<h2 id="使用httpsessionbindinglistener">使用HttpSessionBindingListener</h2>

<p>HttpSessionBindingListener虽然叫做监听器，但使用方法与HttpSessionListener完全不同。 <br>
HttpSessionListener只需要设置到web.xml中就可以监听整个应用中的所有session；HttpSessionBindingListener必须实例化后放入某一个session中，才可以进行监听。 <br>
从监听范围上比较，HttpSessionListener设置一次就可以监听所有session，HttpSessionBindingListener通常都是一对一的。</p>

<p>javax.servlet.http.HttpSessionBindingListener接口提供了下面的方法： <br>
public void valueBound(HttpSessionBindingEvent event)，当对象正在被绑定到Session中时，Servlet容器会调用这个方法来通知该对象 <br>
public void valueUnbound(HttpSessionBindingEvent event)，当从Session中删除对象时，Servlet容器调用这个方法来通知该对象 <br>
Servlet容器通过HttpSessionBindingEvent对象来通知实现了HttpSessionBindingListener接口的对象，而该对象可以利用HttpSessionBindingEvent对象来访问与它相联系的HttpSession对象，javax.servlet.http.HttpSessionBindingEvent类提供了以下方法： <br>
public HttpSessionBingdingEvent(HttpSession session,java.lang.String name) <br>
public HttpSessionBingdingEvent(HttpSession session,java.lang.String name,java.lang.Object value) <br>
public javax.lang.String getName()，返回绑定到Session中或者从Session中删除的属性的名字 <br>
public java.lang.Object getValue()，返回被添加/删除/替换的属性的值，如果属性被添加或者被删除，这个方法返回属性的值，如果这个属性被替换，这个方法返回属性先前的值 <br>
public HttpSession getSession()，返回HttpSession对象</p>

<p>看一个简单的例子</p>

<pre class="prettyprint"><code class="language-java hljs "><span class="hljs-keyword">package</span> advance;

<span class="hljs-keyword">import</span> javax.servlet.http.HttpSessionBindingListener;
<span class="hljs-keyword">import</span> javax.servlet.http.HttpSessionBindingEvent;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BindingListener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">HttpSessionBindingListener</span>
{</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">valueBound</span>(HttpSessionBindingEvent arg0) {
        System.out.println(<span class="hljs-string">"valueBound"</span>);
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">valueUnbound</span>(HttpSessionBindingEvent arg0) {
        System.out.println(<span class="hljs-string">"valueUnbound"</span>);
    }
}</code></pre>

<p>不需要配置web.xml，但要将listener加入session的属性中：</p>

<pre><code>BindingListener  binding = new BindingListener();  
session.setAttribute("anyname", binding );//这个时候要触发valueBound方法了 
</code></pre>

<p>valueUnbound()的触发条件是以下三种情况： <br>
1. 执行session.invalidate()时。 <br>
2. session超时自动销毁时。 <br>
3. 执行session.setAttribute(“anyname”, “其他对象”)或session.removeAttribute(“anyname”)将listener从session中删除时。只要不将listener从session中删除，就可以监听到session的销毁。</p>

<h2 id="参考">参考</h2>

<p><a href="http://blog.csdn.net/mywordandyourword/article/details/18937775">java web session监听销毁跳转</a> <br>
<a href="http://blog.163.com/oyhj_nicholas/blog/static/323592520107310249109/">JSP中设置Session有效时间的三种方式</a></p></div></body>
</html>