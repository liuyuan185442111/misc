<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>关于std::map的节点大小</title>
<link rel="stylesheet" href="https://csdn.net/res-min/themes/base.css" />
<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({ TeX: { equationNumbers: {autoNumber: "all"},extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"] } });
</script>
</head>
<body><div class="container"><p>项目中需要用到很大的map，于是想看一下map本身的存储消耗是多少，于是写了个最简单的allocator来试。 <br>
<a href="https://blog.csdn.net/liuyuan185442111/article/details/45743345" title="allocator">以下MyAlloc的默认构造、（广义的）复制构造、rebind是必需的，为了查看分配空间的大小，allocate也是必需的。</a> <br>
用greater&lt;int&gt;()显式的构造map是为了说明，<a href="https://blog.csdn.net/liuyuan185442111/article/details/76767509#t3" title="Effective STL">“c++尽可能将语句解释为函数声明”</a>，语句</p>

<pre><code>map&lt;int,int,greater&lt;int&gt;,MyAlloc&lt;pair&lt;const int,int&gt; &gt; &gt; m(greater&lt;int&gt;());
</code></pre>

<p>将被编译器解释为一个函数声明，形式参数是一个省略名字的函数指针。 <br>
把形式参数的声明用括号括起来是非法的，给函数参数加上括号却是合法的，所以给greater&lt;int&gt;()套上括号就可以了。 <br>
以下是完整代码：</p>



<pre class="prettyprint"><code class=" hljs cpp"><span class="hljs-preprocessor">#include &lt;iostream&gt;</span>
<span class="hljs-preprocessor">#include &lt;map&gt;</span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> <span class="hljs-built_in">std</span>;

<span class="hljs-comment">//#pragma pack(1)</span>

<span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> T&gt;
<span class="hljs-keyword">class</span> MyAlloc : <span class="hljs-keyword">public</span> allocator&lt;T&gt;
{
<span class="hljs-keyword">public</span>:
    <span class="hljs-keyword">typename</span> allocator&lt;T&gt;::pointer allocate(<span class="hljs-keyword">typename</span> allocator&lt;T&gt;::size_type n, <span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *p=<span class="hljs-number">0</span>)
    {
        <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"allocate "</span> &lt;&lt; n &lt;&lt; <span class="hljs-string">" element whose size is "</span> &lt;&lt; <span class="hljs-keyword">sizeof</span>(T) &lt;&lt; endl;
        <span class="hljs-keyword">return</span> allocator&lt;T&gt;::allocate(n,p);
    }
    <span class="hljs-comment">//用于构造MyAlloc</span>
    MyAlloc(){}
    <span class="hljs-comment">//使MyAlloc可用于红黑树节点</span>
    <span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> U&gt; <span class="hljs-keyword">struct</span> rebind
    {
        <span class="hljs-keyword">typedef</span> MyAlloc&lt;U&gt; other;
    };
    <span class="hljs-comment">//用于容器的get_allocator方法</span>
    <span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> U&gt; MyAlloc(<span class="hljs-keyword">const</span> MyAlloc&lt;U&gt;&amp; alloc){}
};

<span class="hljs-keyword">int</span> main()
{
    <span class="hljs-stl_container"><span class="hljs-built_in">map</span>&lt;<span class="hljs-keyword">int</span>,<span class="hljs-keyword">int</span>,greater&lt;<span class="hljs-keyword">int</span>&gt;</span>,MyAlloc&lt;pair&lt;<span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span>,<span class="hljs-keyword">int</span>&gt; &gt; &gt; m((greater&lt;<span class="hljs-keyword">int</span>&gt;()));
    m[<span class="hljs-number">1</span>] = <span class="hljs-number">101</span>;
    m[<span class="hljs-number">2</span>] = <span class="hljs-number">102</span>;
    m[<span class="hljs-number">3</span>] = <span class="hljs-number">103</span>;
    <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"first key is "</span> &lt;&lt; m.begin()-&gt;first &lt;&lt; endl;
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}</code></pre>

<p>gcc4.1.2中每个节点大小是24，在4.3.2,4.4.4,6.3中每个节点的大小是40。 <br>
可见如果key和value只是int，map本身的存储开销还是很大的。</p></div></body>
</html>